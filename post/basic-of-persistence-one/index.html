<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
<title>
    Elvis Zhang
</title>
<!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/r29/html5.js"></script><![endif]-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<meta name="author" content="Elvis">
<meta name="description" content="The easy way or the right way!">
<meta name="keywords" content="Dead">
<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
<link rel="stylesheet" href="https://blog.shunzi.tech/styles/main.css" />
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/1.7.1/jquery.min.js"></script>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/css/style.min.css" />
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/tocbot.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/script.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/icon.min.js"></script>
        
            <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/Card/prism.min.js"></script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/css/Card/prism.min.css" />
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css">
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js"></script>
            
                <!--点击特效-->
                <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/love.min.js"></script>
                
                        <!--CDN样式-->
                        <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/hit-kounter-lc-0.3.0.js"></script>
                        <script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
                        
                            <script>
                                (function() {
                                    var bp = document.createElement('script');
                                    var curProtocol = window.location.protocol.split(':')[0];
                                    if (curProtocol === 'https') {
                                        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                                    } else {
                                        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                                    }
                                    var s = document.getElementsByTagName("script")[0];
                                    s.parentNode.insertBefore(bp, s);
                                })();
                            </script>
                            
                                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143818020-1"></script>
                                <script>
                                    window.dataLayer = window.dataLayer || [];

                                    function gtag() {
                                        dataLayer.push(arguments);
                                    }
                                    gtag('js', new Date());
                                    gtag('config', 'UA-143818020-1');
                                </script>
                                
</head>

<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
                <a href="https://blog.shunzi.tech">
                    Elvis Zhang
                </a>
            </div>
            <div id="tp-weather-widget"></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/">
                        主页
                    </a>
                    
                    <a class="menu-item" href="/archives">
                        归档
                    </a>
                    
                    <a class="menu-item" href="/tag/diary">
                        随笔
                    </a>
                    
                    <a class="menu-item" href="/tags">
                        标签
                    </a>
                    
                    <a class="menu-item" href="/post/about">
                        关于
                    </a>
                    
                        <input id="switch_default" type="checkbox" class="switch_default">
                        <label for="switch_default" class="toggleBtn"></label>
            </div>
            <form id="gridea-search-form" data-update="1623475328561" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
            </form>
        </div>
    </nav>

    
        <nav class="navbar-mobile" id="nav-mobile">
            <div class="container">
                <div class="navbar-header">
                    <div>
                        <a href="https://blog.shunzi.tech">
                            Elvis Zhang
                        </a>
                        <!--en-->
                        <a id="mobile-toggle-theme-en" class="a en">&nbsp;Dark</a>
                        <!--zh-->
                        <a id="mobile-toggle-theme-zh" class="a zh">&nbsp;&#x6697;&#x9ED1;</a>
                    </div>
                    <form id="gridea-search-form" data-update="1623475328561" action="/search/index.html">
                        <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
                    </form>
                    <!--en-->
                    <div class="menu-toggle" id="menu-toggle-en" onclick="mobileBtn()">&#9776; Menu</div>
                    <!--zh-->
                    <div class="menu-toggle" id="menu-toggle-zh" onclick="mobileBtn()">&#9776; &#x83DC;&#x5355;</div>

                </div>
                <div class="menu" id="mobile-menu">
                    
                        <a class="menu-item" href="/">
                            主页
                        </a>
                        
                        <a class="menu-item" href="/archives">
                            归档
                        </a>
                        
                        <a class="menu-item" href="/tag/diary">
                            随笔
                        </a>
                        
                        <a class="menu-item" href="/tags">
                            标签
                        </a>
                        
                        <a class="menu-item" href="/post/about">
                            关于
                        </a>
                        
                </div>
            </div>
        </nav>
</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementById("menu-toggle-en");
        var toggleMenu_zh = document.getElementById("menu-toggle-zh");

        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.display != "none") {
            if (toggleMenu.classList.contains("active")) {
                toggleMenu.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu.classList.add("active")
                mobileMenu.classList.add("active")
            }
        } else if (toggleMenu_zh.display != "none") {
            if (toggleMenu_zh.classList.contains("active")) {
                toggleMenu_zh.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu_zh.classList.add("active")
                mobileMenu.classList.add("active")
            }
        }

    }
</script>



    <script>
        (function(a, h, g, f, e, d, c, b) {
            b = function() {
                d = h.createElement(g);
                c = h.getElementsByTagName(g)[0];
                d.src = e;
                d.charset = "utf-8";
                d.async = 1;
                c.parentNode.insertBefore(d, c)
            };
            a["SeniverseWeatherWidgetObject"] = f;
            a[f] || (a[f] = function() {
                (a[f].q = a[f].q || []).push(arguments)
            });
            a[f].l = +new Date();
            if (a.attachEvent) {
                a.attachEvent("onload", b)
            } else {
                a.addEventListener("load", b, false)
            }
        }(window, document, "script", "SeniverseWeatherWidget", "//cdn.sencdn.com/widget2/static/js/bundle.js?t=" + parseInt((new Date().getTime() / 100000000).toString(), 10)));
        window.SeniverseWeatherWidget('show', {
            flavor: "slim",
            location: "WWEFQFPJZ7T8",
            geolocation: true,
            language: "auto",
            unit: "c",
            theme: "auto",
            token: "61bcc333-3305-4728-9465-6785274bb0a3",
            hover: "enabled",
            container: "tp-weather-widget"
        })
    </script>
    
            <div class="main">
                <div class="container">
                    <article class="post-wrap">
                        <header class="post-header">
                            <h1 class="post-title">
                                Series One of Basic of Persistence - I/O Devices
                            </h1>
                            
                                    <!--zh-->
                                    <div class="post-meta zh">
                                        &#x4F5C;&#x8005;:
                                        <a itemprop="author" rel="author" href="/">
                                            Elvis Zhang
                                        </a>
                                        <span class="post-time">&#x65E5;&#x671F;: <a href="#">2020-07-18</a></span>
                                        <span class="post-readtime">&#x9605;&#x8BFB;&#x65F6;&#x95F4;:<a
                                    href="#">13.8
                                    &#x5206;&#x949F;</a></span>
                                        <span class="post-words">&#x5B57;&#x6570;:<a href="#">3643</a></span>
                                        
                                            <span class="post-category">&#x5206;&#x7C7B;:
                                
                                <a href="https://blog.shunzi.tech/tag/3zCwFWPHxH/">存储</a>
                                
                                <a href="https://blog.shunzi.tech/tag/la-n8a0mo/">读书笔记</a>
                                
                                <a href="https://blog.shunzi.tech/tag/os/">OS</a>
                                
                            </span>
                                            
                                                阅读量:
                                                <span data-hk-page="current"> - </span>
                                                
                                    </div>
                                    
                        </header>
                        
                            <img class="post-feature-image" src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200717213648.png" alt="">
                          
                        <div class="post-content">
                            <blockquote>
<ul>
<li>本篇为持久化技术的基础篇系列第一篇（I/O 设备），即一些硬件设备基础知识以及基础的 IO 处理相关知识，可以结合之前的一篇博客 <a href="https://blog.shunzi.tech/post/flavor-of-io/">Flavor of IO</a>。</li>
</ul>
</blockquote>
<!-- more -->
<h2 id="chapter-index">Chapter Index</h2>
<ul>
<li>Basic of Persistence
<ul>
<li><a href="https://blog.shunzi.tech/post/flavor-of-io/">Flavor of IO</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-one/">I/O Devices</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-two/">Hard Disk Drives</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-three/">Files and Directories</a></li>
</ul>
</li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-four/">File Systems Implementation</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-five/">Locality and The Fast File System</a></li>
<li><a href="https://blog.shunzi.tech/post/dist-block-consistency/#toc-heading-16">Crash Consistency: FSCK and Journaling</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-six/">Log-structured File System</a></li>
</ul>
<h1 id="basic-of-persistence">Basic of Persistence</h1>
<h2 id="before-persistence">Before Persistence</h2>
<ul>
<li>原书中的章前对话中对 Persistence 的概念举例进行了通俗的解释：假设我们摘了很多桃子，并且我们想这些桃子能够保存的更久一点，但是水果的保存总会受天气温度等环境因素的影响，我们通常可能会将桃子晒成果干，或者做成 PIE 一样的能够保存的更久一点的形式。</li>
<li>数据信息同理，我们想要持久地保存数据，以防出现计算机宕机/磁盘故障/掉电等其他事件破坏了我们的数据。</li>
</ul>
<h2 id="io-devices">I/O Devices</h2>
<blockquote>
<ul>
<li>问题1：I/O 如何集成到系统中？</li>
<li>问题2：I/O 机制是什么样的？</li>
<li>问题3：如何让 I/O 变得更加高效？</li>
</ul>
</blockquote>
<h3 id="system-architecture">System Architecture</h3>
<ul>
<li>
<p>如图所示的 <strong>传统意义上的系统架构</strong>： （<strong>物理结构和成本</strong> 决定了架构）</p>
<ul>
<li>CPU 和 Memory 通过内存总线相连</li>
<li>部分外设（高性能 I/O 设备）通过通用的 I/O 总线（许多系统中为 PCI）和内存总线相连。eg. 显卡</li>
<li>其他外设则通过外围总线（SCSI, SATA, USB）相连，通常为 disk, mice, keyborads 等设备</li>
</ul>
</li>
<li>
<p>思想：性能要求高的设备，离 CPU 更近，总线成本也更高，不适宜接入大量外设<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200717220152.png" alt="20200717220152" loading="lazy"></p>
</li>
<li>
<p>如图所示的 <strong>现代系统结构</strong>（Intel's Z270）：现代系统越来越多地使用专用芯片组和更快的点对点互连来提高性能。</p>
<ul>
<li>CPU 同时直连 Memory 和 Graphics，保证其对高性能的需求</li>
<li>CPU 通过 Intel 专有的 DMI (Direct Media Interface) 连接 I/O 芯片，其他外设再通过不同的接口连接到 I/O Chip</li>
<li>Disk 通过 ATA / SATA / eSATA 连接；然后 USB 相关设备通过 USB 连接；网络接口（网卡）以及高性能存储设备（如 NVMe SSD）通过 PCIe 连接<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200717221226.png" alt="20200717221226" loading="lazy"></li>
</ul>
</li>
</ul>
<h3 id="a-canonical-device-and-the-canonical-protocol">A Canonical Device and The Canonical Protocol</h3>
<h4 id="device">Device</h4>
<ul>
<li>一个标准化的设备主要由两部分组成：<strong>硬件接口</strong> 和 <strong>内部结构</strong>
<ul>
<li>硬件接口：暴露给系统的其他部分，相当于一层对外提供了相应的程序接口的软件，需要借助硬件接口层控制硬件的具体操作。</li>
<li>内部结构：设备的这一部分是特定于实现的，负责实现设备呈现给系统的抽象。非常简单的设备将有一个或几个硬件芯片来实现其功能;更复杂的设备将包括一个简单的CPU、一些通用内存和其他特定于设备的芯片来完成它们的工作。如 RAID 控制器就由大量的 firmware 组成来实现相应的功能。<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200718162725.png" alt="20200718162725" loading="lazy"></li>
</ul>
</li>
</ul>
<h4 id="protocol">Protocol</h4>
<ul>
<li>Interface 由三个寄存器组成：
<ul>
<li>status：查看当前设备的状态</li>
<li>command：告诉设备执行某项任务</li>
<li>data：传递数据给设备，或者从设备中获取数据</li>
</ul>
</li>
<li>交互过程示例如下：
<ul>
<li>step 1: 通过重复地读取 STATUS 寄存器判断是否 Device 空闲，即轮询 Device</li>
<li>step 2: 将此次需要处理的数据发送 DATA 寄存器，若当前设备为磁盘设备，大量的写操作需要传输数据块到数据寄存器中，倘若 CPU 参与了此次数据移动过程，此次过程被称为 PIO（Programmed I/O）</li>
<li>step 3：将此次需要进行的指令发送到指令寄存器中，显示地告诉设备数据也已经准备就绪，可以开始执行对应的操作</li>
<li>step 4：等待设备完成操作，再次对设备进行轮询，重复 step 1</li>
</ul>
</li>
</ul>
<pre><code>While (STATUS == BUSY)
  ; // wait until device is not busy
Write data to DATA register
Write command to COMMAND register
  (starts the device and executes the command)
While (STATUS == BUSY)
; // wait until device is done with your request
</code></pre>
<ul>
<li>该协议的优点在于可以正常工作以及足够简单，但是不够高效。因为轮询机制的存在，需要花费大量的 CPU 时钟来等待设备完成前一个任务。</li>
<li><strong>CRUX：有什么比较好的方式可以检查设备状态，不用通过轮询，从而减小 CPU 开销？</strong></li>
</ul>
<h3 id="lowering-cpu-overhead-with-interrupts">Lowering CPU Overhead With Interrupts</h3>
<ul>
<li>使用中断机制代替轮询，当设备完成了相应任务之后，触发一个硬中断，CPU 再去对应地执行中断处理任务，等待任务完成的过程中，CPU 可以切换去处理其他任务。</li>
<li>中断机制允许计算和 I/O 操作同时进行，从而提升了利用率。如图所示，上图使用 polling 机制等待读取到存储在磁盘上的数据，下图所示则使用了中断机制，在等待上一个任务完成的过程中可以执行别的任务，上一个任务完成后再使用中断通知CPU，从而唤醒 Process 1 继续执行</li>
</ul>
<p><img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200718170449.png" alt="20200718170449" loading="lazy"><br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200718170720.png" alt="20200718170720" loading="lazy"></p>
<ul>
<li>但需要注意的是，中断机制不一定总是比轮询机制高效，因为中断机制引入了不同进程之间的切换操作，该操作也是有一定的开销的，针对通过比较短时间的轮询就能实现的操作往往会比中断机制更为高效。同时大量的中断操作可能导致操作系统出现活锁。</li>
<li>因此，
<ul>
<li>如果一个设备的处理速度比较快，通常轮询机制更为高效</li>
<li>如果处理速度较慢，通常中断机制更为高效</li>
<li>如果处理速度未知，时快时慢，通常使用混合机制来处理，即两阶段方式：轮询一段时间之后执行中断。</li>
</ul>
</li>
<li>在网络传输过程中，也尽量不使用中断，因为针对那种大流量的数据传输，每一个数据包就进行一次中断，会出现活锁（即只处理中断，无法处理实际的操作和请求）。</li>
<li>另一个基于中断的优化是合并操作，在这种情况下，一个需要首先引起一个中断的设备在将中断发送给CPU之前会等待一点时间。在等待期间，其他请求可能很快就会完成，因此可以将多个中断合并为单个中断交付，从而降低中断处理的开销。当然，等待太久会增加请求的延迟。</li>
</ul>
<h3 id="more-efficient-data-movement-with-dma">More Efficient Data Movement With DMA</h3>
<ul>
<li>除了轮询机制占用 CPU 的资源以外，针对 PIO 过程，将大块数据传输到设备时，CPU又一次因一个相当琐碎的任务而负担过重。如图所示，Process 1 将要写部分数据到磁盘，发起 I/O 操作，首先将数据从内存拷贝到设备，如图中 c 所示，拷贝完成后开始向磁盘发起写。</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200718194026.png" alt="20200718194026" loading="lazy"></figure>
<ul>
<li>CRUX：如何降低 PIO 过程中设备上的数据寄存器的传输操作给 CPU 带来的开销？</li>
</ul>
<h4 id="solution-dma">Solution DMA</h4>
<ul>
<li><strong>Direct Memory Access (DMA)</strong>：直接内存访问。DMA 引擎本质上是系统中的一个具体的设备，它可以在没有太多 CPU 干预的情况下协调设备和主内存之间的传输。</li>
<li>DMA 的工作原理如下：为了将数据传输到设备，操作系统需要通过程序的方式告诉 DMA 引擎数据在内存中的位置、要复制多少数据以及要将数据发送到哪个设备。告诉 DMA 之后，操作系统的任务就完成了，就可以切换去执行其他任务。DMA 开始工作，当完成相应的数据传输以后，发起一个中断，此时 OS 就知道传输已经完成了，将会继续执行之前挂起的任务。</li>
<li>如图所示，相比于无 DMA 的方案，数据拷贝的过程主要由 DMA 来完成，此时 CPU 可以去执行别的任务来提高利用率。<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200719124607.png" alt="20200719124607" loading="lazy"></li>
</ul>
<h3 id="methods-of-device-interaction">Methods Of Device Interaction</h3>
<ul>
<li>CRUX: 硬件与设备之间如何进行交互的？</li>
</ul>
<h4 id="io-instructions">I/O instructions</h4>
<ul>
<li>最古老的方法（被IBM大型机使用多年），显示的 I/O instructions。这些指令为操作系统指定了将数据发送到特定设备寄存器的方法，因此允许构建上述协议。</li>
<li>例如 x86 机器上就会用 in/out 指令和设备进行通信，比如发送数据到指定设备，caller 需要指定一个存储该数据的寄存器，以及具体的端口来表明是哪个设备，才能真正地执行对应的操作。</li>
<li>I/O instructions 通常是高优先级的，因为通常是由 OS 发出相应的指令，因此 OS 也是唯一一个允许直接和设备通信的实体。假设所有程序都能读写磁盘，将会造成十分混乱的局面，每个程序都将能根据这个漏洞操纵整个机器。</li>
</ul>
<h4 id="memory-mapped-io">Memory-mapped I/O</h4>
<ul>
<li>该方法让硬件寄存器能够如在内存中一样被直接访问。为了访问某一个寄存器，操作系统发起一个对相应地址的 load (to read) 或者 store (to write) 指令，然后硬件将相应的指令发送到对应的设备。</li>
<li>这两种方法都没有太大的优势。内存映射方法很好，因为不需要新的指令来支持它，但是这两种方法现在仍然在使用。</li>
</ul>
<h3 id="fitting-into-the-os-the-device-driver">Fitting Into The OS: The Device Driver</h3>
<ul>
<li>CRUX: 不同的设备可能使用了不同的接口，操作系统如何适配对应的设备，如何屏蔽设备指令的实现细节？</li>
<li>解决该问题的核心思想为 <strong>抽象</strong>。在操作系统的最底层，必须要有一层软件，知道和硬件交互的具体细节，我们称之为设备驱动，设备交互的任何细节都被封装在其中。</li>
<li>以文件系统软件栈为例，应文件系统完全不知道自己使用了哪种类型的磁盘，因为文件系统通常只对通用块层发起对块的读写，由通用块层将读写请求路由到合适的设备驱动，再由设备驱动处理具体请求。</li>
<li>图中还表示了裸设备接口，专门提供给一些特殊的应用，如 fsck 或者磁盘分区工具，从而不使用文件抽象直接读写块。大多数系统都提供了这种接口以供一些低级别的存储管理应用使用。<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200719142219.png" alt="20200719142219" loading="lazy"></li>
<li>这种抽象/封装的方式也有一定的坏处。即当底层设备拥有大量的特性的时候，为了提供通用的接口，可能导致无法充分利用其特性。例如 SCSI 设备本身是支持了大量的错误处理的，相比于 ATA/IDE，但是在通用块层的实现只能报告为 EIO (generic IO error)</li>
<li>随着时间的的推移，设备驱动的代码占据了整个 Linux 代码的 70%，由于设备驱动的复杂性和多样性，很多设备驱动代码是由业余人士贡献的，往往可能导致 Linux 内核 crash。</li>
</ul>
<h3 id="case-study-a-simple-ide-disk-driver">Case Study: A Simple IDE Disk Driver</h3>
<ul>
<li>
<p>如图所示，IDE 磁盘暴露的接口主要由四个寄存器组成：(这些寄存器通过读写具体的 I/O 地址从而变得可用，使用 in/out 指令)</p>
<ul>
<li>控制寄存器 control</li>
<li>命令块寄存器 command block</li>
<li>状态寄存器 status</li>
<li>错误寄存器 error<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200719161922.png" alt="20200719161922" loading="lazy"></li>
</ul>
</li>
<li>
<p>假设设备已经初始化，与设备交互的基本协议如下：</p>
<ul>
<li>等待驱动器准备好：读取状态寄存器 0x1F7 (轮询直到 READY 或者 NOT BUSY)</li>
<li>向命令寄存器写入参数 (0x1F2-0x1F6)：写入扇区计数（Sector Count），要访问的扇区对应的逻辑块地址（LBA of sectors to be accessed），驱动器编号（IDE 只允许两个设备，master = 0x00, slave = 0x10）</li>
<li>开始 I/O 操作 (0x1F7)：向命令寄存器发起读写，直接将 READ/WRITE 命令写入到命令寄存器。</li>
<li>数据传输（写操作）：直到驱动器 Status Ready 且驱动器请求数据，将数据写入写入到 Data Port.</li>
<li>处理中断：最简单的例子就是为每一个传输了的扇区处理一次中断，更为复杂的实现则是等整个传输过程结束之后处理中断。</li>
<li>错误处理：每一次操作之后，读取状态寄存器，如果为 ERROR 状态，对应地读取错误寄存器查看具体的错误原因。</li>
</ul>
</li>
<li>
<p>该协议的大部分都可以 xv6 IDE Driver 的实现中找到。如下所示的代码中主要实现了四个功能：</p>
<ul>
<li><code>ide_rw</code>：如果有任务挂起，则将请求排队，或者 <code>ide_start_request</code> 直接发送到磁盘。都需要等待请求完成，调用线程进入休眠状态。</li>
<li><code>ide start request</code>: 发送请求到磁盘，in/out 指令被调用来对磁盘进行读写，一开始需要调用 <code>ide_wait_ready()</code></li>
<li><code>ide_wait_ready</code>：确保设备在接受请求之前处于就绪状态。</li>
<li><code>ide_intr</code>: 当中断发生时被调用，如果是读请求，则从设备中读取数据，并唤醒等待该 I/O 操作的进程继续执行。如果 I/O 队列中还有别的请求，则开始执行下一个 <code>ide_start_request()</code></li>
</ul>
</li>
</ul>
<pre><code class="language-C">static int ide_wait_ready() {
  while (((int r = inb(0x1f7)) &amp; IDE_BSY) || !(r &amp; IDE_DRDY)); 
  // loop until drive isn’t busy
}

static void ide_start_request(struct buf *b) {
  ide_wait_ready();
  outb(0x3f6, 0); // generate interrupt
  outb(0x1f2, 1); // how many sectors?
  outb(0x1f3, b-&gt;sector &amp; 0xff); // LBA goes here ...
  outb(0x1f4, (b-&gt;sector &gt;&gt; 8) &amp; 0xff); // ... and here
  outb(0x1f5, (b-&gt;sector &gt;&gt; 16) &amp; 0xff); // ... and here!
  outb(0x1f6, 0xe0 | ((b-&gt;dev&amp;1)&lt;&lt;4) | ((b-&gt;sector&gt;&gt;24)&amp;0x0f));
  if(b-&gt;flags &amp; B_DIRTY){
    outb(0x1f7, IDE_CMD_WRITE); // this is a WRITE
    outsl(0x1f0, b-&gt;data, 512/4); // transfer data too!
  } else {
    outb(0x1f7, IDE_CMD_READ); // this is a READ (no data)
  }
}

void ide_rw(struct buf *b) {
  acquire(&amp;ide_lock);
  for (struct buf **pp = &amp;ide_queue; *pp; pp=&amp;(*pp)-&gt;qnext); 
  // walk queue
  *pp = b; // add request to end
  if (ide_queue == b) // if q is empty
    ide_start_request(b); // send req to disk
  while ((b-&gt;flags &amp; (B_VALID|B_DIRTY)) != B_VALID)
    sleep(b, &amp;ide_lock); // wait for completion
  release(&amp;ide_lock);
}

void ide_intr() {
  struct buf *b;
  acquire(&amp;ide_lock);
  if (!(b-&gt;flags &amp; B_DIRTY) &amp;&amp; ide_wait_ready() &gt;= 0)
    insl(0x1f0, b-&gt;data, 512/4); // if READ: get data
  b-&gt;flags |= B_VALID;
  b-&gt;flags &amp;= ˜B_DIRTY;
  wakeup(b); // wake waiting process
  if ((ide_queue = b-&gt;qnext) != 0) // start next request
    ide_start_request(ide_queue); // (if one exists)
  release(&amp;ide_lock);
}

</code></pre>

                        </div>
                        
                            <div class="post-toc">
                                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#chapter-index">Chapter Index</a></li>
</ul>
</li>
<li><a href="#basic-of-persistence">Basic of Persistence</a>
<ul>
<li><a href="#before-persistence">Before Persistence</a></li>
<li><a href="#io-devices">I/O Devices</a>
<ul>
<li><a href="#system-architecture">System Architecture</a></li>
<li><a href="#a-canonical-device-and-the-canonical-protocol">A Canonical Device and The Canonical Protocol</a>
<ul>
<li><a href="#device">Device</a></li>
<li><a href="#protocol">Protocol</a></li>
</ul>
</li>
<li><a href="#lowering-cpu-overhead-with-interrupts">Lowering CPU Overhead With Interrupts</a></li>
<li><a href="#more-efficient-data-movement-with-dma">More Efficient Data Movement With DMA</a>
<ul>
<li><a href="#solution-dma">Solution DMA</a></li>
</ul>
</li>
<li><a href="#methods-of-device-interaction">Methods Of Device Interaction</a>
<ul>
<li><a href="#io-instructions">I/O instructions</a></li>
<li><a href="#memory-mapped-io">Memory-mapped I/O</a></li>
</ul>
</li>
<li><a href="#fitting-into-the-os-the-device-driver">Fitting Into The OS: The Device Driver</a></li>
<li><a href="#case-study-a-simple-ide-disk-driver">Case Study: A Simple IDE Disk Driver</a></li>
</ul>
</li>
</ul>
</li>
</ul>

                            </div>
                            
                                
                                    
                                            <!--zh-->
                                            <section class="post-copyright zh">
                                                <p class="copyright-item ">
                                                    <span>&#x4F5C;&#x8005;:</span>
                                                    <span>Elvis Zhang</span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x6C38;&#x4E45;&#x94FE;&#x63A5;:</span>
                                                    <span><a href="https://blog.shunzi.tech/post/basic-of-persistence-one/">https://blog.shunzi.tech/post/basic-of-persistence-one/</a></span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x534F;&#x8BAE;:</span>
                                                    <span>MIT License</span>
                                                </p>
                                            </section>
                                            
                                                
                                                    
                                                                    <!--Share-->
                                                                    <span style="margin-right:15px">
                        <i class="post-share"></i>
                        <span>&#x5206;&#x4EAB;:</span>
                                                                    <a title="QR 码" target="_blank" href="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://blog.shunzi.tech/post/basic-of-persistence-one/"><i class="fa fa-qrcode"></i></a>
                                                                    <a title="QQ" target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://blog.shunzi.tech/post/basic-of-persistence-one/&sharesource=qzone&title=Series One of Basic of Persistence - I/O Devices&pics=https://blog.shunzi.tech/images/avatar.png?v=1623475328561&summary=&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;本篇为持久化技术的基础篇系列第一篇（I/O 设备），即一些硬件设备基础知识以及基础的 IO 处理相关知识，可以结合之前的一篇博客 &lt;a href=&#34;https://blog.shunzi.tech/post/flavor-of-io/&#34;&gt;Flavor of IO&lt;/a&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
"><i class="fa fa-qq"></i></a>
                                                                    <a title="新浪微博" target="_blank" href="https://service.weibo.com/share/share.php?url=https://blog.shunzi.tech/post/basic-of-persistence-one/&sharesource=weibo&title=Series One of Basic of Persistence - I/O Devices + " - " + &lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;本篇为持久化技术的基础篇系列第一篇（I/O 设备），即一些硬件设备基础知识以及基础的 IO 处理相关知识，可以结合之前的一篇博客 &lt;a href=&#34;https://blog.shunzi.tech/post/flavor-of-io/&#34;&gt;Flavor of IO&lt;/a&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&pic="https://blog.shunzi.tech/images/avatar.png?v=1623475328561 "><i class="fa fa-weibo "></i></a>

                                                                    </span>
                                                                    
                                                                            <!--zh-->
                                                                            <section class="post-tags zh ">
                                                                                <div>
                                                                                    <span>&#x6807;&#x7B7E;:</span>
                                                                                    <span class="tag ">
                        
                        
                        <a href="https://blog.shunzi.tech/tag/3zCwFWPHxH/">#
                    存储
                        </a>
                        
                        <a href="https://blog.shunzi.tech/tag/la-n8a0mo/">#
                    读书笔记
                        </a>
                        
                        <a href="https://blog.shunzi.tech/tag/os/">#
                    OS
                        </a>
                        
                            
                                </span>
                                                                                </div>
                                                                                <div>
                                                                                    <a href="javascript:window.history.back();">
                        &#x8FD4;&#x56DE;</a>
                                                                                    <span>&dot;</span>
                                                                                    <a href="#">&#x4E3B;&#x9875;</a>
                                                                                </div>
                                                                            </section>

                                                                            
                                                                                <!---->
                                                                                <section class="post-nav">
                                                                                    
                                                                                        <a class="prev" rel="prev" href="https://blog.shunzi.tech/post/basic-of-persistence-two/">
                                                                                            Series Two of Basic of Persistence - Hard Disk Drives And RAID
                                                                                        </a>
                                                                                        
                                                                                            
                                                                                                <a class="next" rel="next" href="https://blog.shunzi.tech/post/dist-block-consistency/">
                                                                                                    存储系统中的一致性
                                                                                                </a>
                                                                                                
                                                                                </section>
                    </article>
                </div>
                
                                            
                                                <script type="application/javascript" src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
<div id="vlaine-comment"></div>
<script type="application/javascript">
    new Valine({
        el: '#vlaine-comment',
        appId: 'Pj5H1z0w7hJlLGJpGBh9NrCq-MdYXbMMI',
        appKey: 'LdR8vK5EaBfK87esF7tlbsXe',
        pageSize: 5,
        avatar: 'mp',
        placeholder: '来都来了，不妨评论一下',
        visitor: false,
        highlight: false,
        recordIP: false,
    })
</script>
                                                    
            </div>
    </div>
    </div>
    </div>
    
        <footer id="footer" class="footer">
            <div class="copyright">
                
                        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
                            
                                <b id="hitokoto"></b><br>
                                
                                        <svg viewBox="0 0 1024 1024" style="margin-left: 5px;margin-right: 5px;" version="1.0" width="8" height="8" class="my-face">
            <path
                d="M863.597631 513.574282l-271.33965-140.213484L729.783667 81.926656c3.583731-7.87141 7.167462-15.742819 7.167462-25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0-39.293053 12.607055c-1.791866 1.59988-3.519736 3.19976-5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0-19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c-12.479064 25.214109-1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591-4.735645 44.604655-15.742819l480.091993-403.297753a55.547834 55.547834 0 0 0 19.646526-47.228458 61.243407 61.243407 0 0 0-32.12559-44.156688z"
                fill="#93b5cf"></path>
        </svg>
                                        Elvis Zhang &copy;Copyright
                                            <script>
                                                var date = new Date();
                                                document.write("" + date.getFullYear());
                                            </script>
                                            | Powered by
                                            <a href="https://github.com/" target="_blank">
                                                Github Pages
                                            </a>
            </div>
            <div id="update" style="display:none;">
                on
            </div>
            
                <div id="version" style="display:none;">
                    1.7.6
                </div>
                
                    <script>
                        var port = '';
                        
                        document.write('<div id="home_path" style="display:none;">' + document.location.protocol + '//' + window.document.location.hostname + port + '</div>')
                    </script>
        </footer>
        
            <script src='https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js'></script>
            
                <script>
                    
                    
                    loadlive2d();
                    
                    
                    hitokoto();
                    
                    getStar();
                    hljs.initHighlighting();
                    console.clear();
                    
                    CheckVersion();
                    
                    var newDate = new Date();
                    newDate.setTime(1623475328561);
                    console.log(" Blog Update Time: " + newDate.toLocaleDateString());
                    console.log("\n %c \u26a1Theme:Chic Author's Blog:https://blog.itjoker.cn  Write By ITJoker  \n\n", "color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;");
                </script>
        </div>
</body>
<script>
    scroll();
</script>

</html>