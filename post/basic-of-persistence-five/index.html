<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
<title>
    Elvis Zhang
</title>
<!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/r29/html5.js"></script><![endif]-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<meta name="author" content="Elvis">
<meta name="description" content="The easy way or the right way!">
<meta name="keywords" content="Dead">
<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
<link rel="stylesheet" href="https://blog.shunzi.tech/styles/main.css" />
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/1.7.1/jquery.min.js"></script>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/css/style.min.css" />
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/tocbot.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/script.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/icon.min.js"></script>
        
            <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/Card/prism.min.js"></script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/css/Card/prism.min.css" />
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css">
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js"></script>
            
                <!--点击特效-->
                <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/love.min.js"></script>
                
                    <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic@latest/assets/media/script/APlayer.min.js"></script>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
                    
                        <!--CDN样式-->
                        <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/hit-kounter-lc-0.3.0.js"></script>
                        <script src="https://cdn1.lncld.net/static/js/av-min-1.5.0.js"></script>
                        
                            <script>
                                (function() {
                                    var bp = document.createElement('script');
                                    var curProtocol = window.location.protocol.split(':')[0];
                                    if (curProtocol === 'https') {
                                        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                                    } else {
                                        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                                    }
                                    var s = document.getElementsByTagName("script")[0];
                                    s.parentNode.insertBefore(bp, s);
                                })();
                            </script>
                            
                                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143818020-1"></script>
                                <script>
                                    window.dataLayer = window.dataLayer || [];

                                    function gtag() {
                                        dataLayer.push(arguments);
                                    }
                                    gtag('js', new Date());
                                    gtag('config', 'UA-143818020-1');
                                </script>
                                
                                    <script type="text/javascript">
                                        var _hmt = _hmt || [];
                                        (function() {
                                            var hm = document.createElement("script");
                                            hm.src = "https://hm.baidu.com/hm.js?225d600be3e5bb9ae41b903854555ba8";
                                            var s = document.getElementsByTagName("script")[0];
                                            s.parentNode.insertBefore(hm, s);
                                        })();
                                    </script>
                                    
</head>

<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
                <a href="https://blog.shunzi.tech">
                    Elvis Zhang
                </a>
            </div>
            <div id="tp-weather-widget"></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/posts">
                        博客
                    </a>
                    
                    <a class="menu-item" href="/archives">
                        归档
                    </a>
                    
                    <a class="menu-item" href="/tag/diary">
                        随笔
                    </a>
                    
                    <a class="menu-item" href="https://blog.shunzi.tech/post/tools">
                        导航
                    </a>
                    
                    <a class="menu-item" href="/tags">
                        标签
                    </a>
                    
                    <a class="menu-item" href="/post/about">
                        关于
                    </a>
                    
                        <input id="switch_default" type="checkbox" class="switch_default">
                        <label for="switch_default" class="toggleBtn"></label>
            </div>
            <form id="gridea-search-form" data-update="1624327255085" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
            </form>
        </div>
    </nav>

    
        <nav class="navbar-mobile" id="nav-mobile">
            <div class="container">
                <div class="navbar-header">
                    <div>
                        <a href="https://blog.shunzi.tech">
                            Elvis Zhang
                        </a>
                        <!--en-->
                        <a id="mobile-toggle-theme-en" class="a en">&nbsp;Dark</a>
                        <!--zh-->
                        <a id="mobile-toggle-theme-zh" class="a zh">&nbsp;&#x6697;&#x9ED1;</a>
                    </div>
                    <form id="gridea-search-form" data-update="1624327255085" action="/search/index.html">
                        <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
                    </form>
                    <!--en-->
                    <div class="menu-toggle" id="menu-toggle-en" onclick="mobileBtn()">&#9776; Menu</div>
                    <!--zh-->
                    <div class="menu-toggle" id="menu-toggle-zh" onclick="mobileBtn()">&#9776; &#x83DC;&#x5355;</div>

                </div>
                <div class="menu" id="mobile-menu">
                    
                        <a class="menu-item" href="/posts">
                            博客
                        </a>
                        
                        <a class="menu-item" href="/archives">
                            归档
                        </a>
                        
                        <a class="menu-item" href="/tag/diary">
                            随笔
                        </a>
                        
                        <a class="menu-item" href="https://blog.shunzi.tech/post/tools">
                            导航
                        </a>
                        
                        <a class="menu-item" href="/tags">
                            标签
                        </a>
                        
                        <a class="menu-item" href="/post/about">
                            关于
                        </a>
                        
                </div>
            </div>
        </nav>
</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementById("menu-toggle-en");
        var toggleMenu_zh = document.getElementById("menu-toggle-zh");

        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.display != "none") {
            if (toggleMenu.classList.contains("active")) {
                toggleMenu.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu.classList.add("active")
                mobileMenu.classList.add("active")
            }
        } else if (toggleMenu_zh.display != "none") {
            if (toggleMenu_zh.classList.contains("active")) {
                toggleMenu_zh.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu_zh.classList.add("active")
                mobileMenu.classList.add("active")
            }
        }

    }
</script>



    <script>
        (function(a, h, g, f, e, d, c, b) {
            b = function() {
                d = h.createElement(g);
                c = h.getElementsByTagName(g)[0];
                d.src = e;
                d.charset = "utf-8";
                d.async = 1;
                c.parentNode.insertBefore(d, c)
            };
            a["SeniverseWeatherWidgetObject"] = f;
            a[f] || (a[f] = function() {
                (a[f].q = a[f].q || []).push(arguments)
            });
            a[f].l = +new Date();
            if (a.attachEvent) {
                a.attachEvent("onload", b)
            } else {
                a.addEventListener("load", b, false)
            }
        }(window, document, "script", "SeniverseWeatherWidget", "//cdn.sencdn.com/widget2/static/js/bundle.js?t=" + parseInt((new Date().getTime() / 100000000).toString(), 10)));
        window.SeniverseWeatherWidget('show', {
            flavor: "slim",
            location: "WWEFQFPJZ7T8",
            geolocation: true,
            language: "auto",
            unit: "c",
            theme: "auto",
            token: "61bcc333-3305-4728-9465-6785274bb0a3",
            hover: "enabled",
            container: "tp-weather-widget"
        })
    </script>
    
            <div class="main">
                <div class="container">
                    <article class="post-wrap">
                        <header class="post-header">
                            <h1 class="post-title">
                                Series Five of Basic of Persistence -  Locality and The Fast File System
                            </h1>
                            
                                    <!--zh-->
                                    <div class="post-meta zh">
                                        &#x4F5C;&#x8005;:
                                        <a itemprop="author" rel="author" href="/">
                                            Elvis Zhang
                                        </a>
                                        <span class="post-time">&#x65E5;&#x671F;: <a href="#">2020-07-23</a></span>
                                        <span class="post-readtime">&#x9605;&#x8BFB;&#x65F6;&#x95F4;:<a
                                    href="#">11.2
                                    &#x5206;&#x949F;</a></span>
                                        <span class="post-words">&#x5B57;&#x6570;:<a href="#">3120</a></span>
                                        
                                            <span class="post-category">&#x5206;&#x7C7B;:
                                
                                <a href="https://blog.shunzi.tech/tag/3zCwFWPHxH/">存储</a>
                                
                                <a href="https://blog.shunzi.tech/tag/la-n8a0mo/">读书笔记</a>
                                
                                <a href="https://blog.shunzi.tech/tag/os/">OS</a>
                                
                            </span>
                                            
                                                阅读量:
                                                <span data-hk-page="current"> - </span>
                                                
                                    </div>
                                    
                        </header>
                        
                            <img class="post-feature-image" src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200717213648.png" alt="">
                          
                        <div class="post-content">
                            <blockquote>
<ul>
<li>本篇为持久化技术的基础篇系列第五篇（局部性和 Fast File System），将以 FFS 为例，可以参考原版论文 <a href="https://dl.acm.org/doi/10.1145/989.990">A fast file system for UNIX</a></li>
</ul>
</blockquote>
<!-- more -->
<h2 id="chapter-index">Chapter Index</h2>
<ul>
<li><a href="">Basic of Persistence</a></li>
<li>Basic of Persistence
<ul>
<li><a href="https://blog.shunzi.tech/post/flavor-of-io/">Flavor of IO</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-one/">I/O Devices</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-two/">Hard Disk Drives</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-three/">Files and Directories</a></li>
</ul>
</li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-four/">File Systems Implementation</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-five/">Locality and The Fast File System</a></li>
<li><a href="https://blog.shunzi.tech/post/dist-block-consistency/#toc-heading-16">Crash Consistency: FSCK and Journaling</a></li>
<li><a href="https://blog.shunzi.tech/post/basic-of-persistence-six/">Log-structured File System</a></li>
</ul>
<h2 id="locality-and-the-fast-file-system">Locality and The Fast File System</h2>
<ul>
<li>最早的文件系统其数据结构设计如下。优势在于设计足够简单，也基本实现了文件系统的抽象：文件和目录的层级结构，但存在比较严重的性能问题，大约只能发挥磁盘带宽 2%。其根本原因在于这种文件系统把磁盘当作了随机访问的内存，数据的存放没有考虑到磁盘的特性，所以在定位数据时开销较大。（实际表现可能为数据块离元数据块较远，所以在读取元数据之后再读取数据块的话 seek 操作开销就很大）<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723101444.png" alt="20200723101444" loading="lazy"></li>
<li>除此以外，因为没有对空闲空间进行高效的管理，所以可能会造成碎片化，空闲空间列表指向的空闲空间可能散布整个磁盘，在分配文件时，它们只需要获取下一个空闲块，其结果是通过在磁盘上来回访问逻辑上连续的文件，从而显著降低性能。如图所示操作将会造成 E 散布磁盘，磁盘的访问无法充分利用顺序特性。<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723102636.png" alt="20200723102636" loading="lazy"></li>
<li>所以现在操作系统都会有相应的磁盘碎片整理工具，它们重新组织磁盘上的数据，以连续地放置文件，并为一个或几个相邻区域腾出空闲空间，移动数据，然后重写索引节点，以反映更改。</li>
<li>还有一个问题就是块大小，块太小将不利于数据的传输，因为需要进行多次的定位操作，但是可以最小化碎片化的程度。快太大，碎片化就更严重。</li>
<li><strong>CRUX：如何组织磁盘上的数据提升性能？</strong></li>
</ul>
<h3 id="ffs-disk-awareness-is-the-solution">FFS: Disk Awareness Is The Solution</h3>
<ul>
<li>Fast File System (FFS) 基于磁盘感知的分配策略设计了文件系统。该文件系统开启了文件系统的新纪元，即对外仍然暴露相同的 API，只是在底层提供不同的实现。</li>
</ul>
<h3 id="organizing-structure-the-cylinder-group">Organizing Structure: The Cylinder Group</h3>
<ul>
<li>FFS 将磁盘划分成了多个 Cylinder Groups。一个 Cylinder 对应磁盘上的一组磁道，N 个 Cylinders 组成一组。<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723104510.png" alt="20200723104510" loading="lazy"></li>
<li>现代文件系统对外暴露的是块的逻辑地址空间，并向客户端隐藏了实际的细节。因此现代文件系统将磁盘组织成了 block groups，每一个部分就是磁盘地址空间的一部分。<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723104944.png" alt="20200723104944" loading="lazy"></li>
<li>不管您把它们称为柱体组还是块组，这些组都是FFS用来提高性能的核心机制。重要的是，通过在同一组中放置两个文件，FFS可以确保逐个访问不会导致跨磁盘查找时间过长。为了使用这些组来存取数据，就需要把文件和目录都放在一个组中，并且该组内只有包含了足够多的信息才能确保高效。如图所示，一个组内需要包含相应的一些信息。
<ul>
<li>Super block，每一个组中保留了超级块的副本信息，是为了防止原有的超级块损坏后无法访问文件系统，使用副本可以恢复。</li>
<li>inode/data bitmap 用于追踪组内 inode 和 data 的分配情况</li>
<li>数据块和 vsfs 一样用于存储数据，且作为一个组的最大组成部分。<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723105500.png" alt="20200723105500" loading="lazy"></li>
</ul>
</li>
</ul>
<h3 id="policies-how-to-allocate-files-and-directories">Policies: How To Allocate Files and Directories</h3>
<ul>
<li><strong>核心思想：把相关的数据放在一起</strong></li>
<li>目录的放置：找一个组，已分配的目录较少，有大量空闲 inodes。</li>
<li>文件的放置：确保数据块和 inode 在一个组中，同一个目录下的文件尽量放在一个目录中</li>
<li>假设每组 10 inodes 和 10 data blocks。现在需要放置三个目录 <code>/</code>, <code>/a</code>, <code>/b</code> 和四个文件 <code>/a/c</code>，<code>/a/d</code>，<code>/a/e</code>，<code>/b/f</code>。假设目录占据一个块，文件占据两个块：</li>
</ul>
<table>
<thead>
<tr>
<th>group</th>
<th>inodes</th>
<th>data</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>/---------</td>
<td>/---------</td>
</tr>
<tr>
<td>1</td>
<td>acde------</td>
<td>accddee---</td>
</tr>
<tr>
<td>2</td>
<td>bf--------</td>
<td>bff-------</td>
</tr>
<tr>
<td>3</td>
<td>----------</td>
<td>----------</td>
</tr>
<tr>
<td>4</td>
<td>----------</td>
<td>----------</td>
</tr>
<tr>
<td>5</td>
<td>----------</td>
<td>----------</td>
</tr>
<tr>
<td>6</td>
<td>----------</td>
<td>----------</td>
</tr>
<tr>
<td>7</td>
<td>----------</td>
<td>----------</td>
</tr>
</tbody>
</table>
<ul>
<li>对比散步所有 inode 到所有组的分配策略，为了防止没有组的 inode table 被很快填满：对比之下，对文件/a/c、/a/d和/a/e的访问现在跨越三个组，而不是按FFS方法的一个组。</li>
</ul>
<table>
<thead>
<tr>
<th>group</th>
<th>inodes</th>
<th>data</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>/---------</td>
<td>/---------</td>
</tr>
<tr>
<td>1</td>
<td>a---------</td>
<td>a---------</td>
</tr>
<tr>
<td>2</td>
<td>b---------</td>
<td>b---------</td>
</tr>
<tr>
<td>3</td>
<td>c---------</td>
<td>cc--------</td>
</tr>
<tr>
<td>4</td>
<td>d---------</td>
<td>dd--------</td>
</tr>
<tr>
<td>5</td>
<td>e---------</td>
<td>ee--------</td>
</tr>
<tr>
<td>6</td>
<td>f---------</td>
<td>ff--------</td>
</tr>
<tr>
<td>7</td>
<td>----------</td>
<td>----------</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>目录中的文件通常是一起访问的</strong>：想象一下，编译一堆文件，然后将它们链接到一个可执行文件中，正是因为存在基于命名空间的局部性，确保了相关的文件之间的访问是又好又快的，FFS 才能提高相应的性能。</li>
</ul>
<h3 id="measuring-file-locality">Measuring File Locality</h3>
<ul>
<li>使用 SEER 来追踪和分析文件访问的距离。比如打开了文件 f，再打开 f 对应的路径长度为 0，因为是同一个文件，但假如位于同一个目录 dir 下的 f 和 g，先打开了 f 后打开了 g，那么访问距离就变成了 1，简而言之，就是寻找两个文件的相同父目录需要多少次操作。</li>
<li>从下图所示的结果发现，约有 7% 的文件访问操作是针对已经打开了的文件，约有 40% 的操作是针对同一个文件或者同一个目录下的文件的访问。因此 FFS 的局部性假设是有一定根据的。</li>
<li>除此以外从图中看出约有 25% （看 1 和 2 之间的纵轴差值）的数据访问对应的访问距离为 2，当用户以多层次的方式结构化了一组相关目录并在它们之间一致地跳转时，就会发生这种类型的局部性。比如 <code>proj/src/foo.c</code> 和 <code>proj/obj/foo.o</code>。FFS 不会捕获这种类型的局部性，因为这样的操作会造成更多的 seek。</li>
<li>作为对比，还引入了 Random trace。通过 SEER Trace 中已经存在的文件进行随机的选择来模拟的，并计算对应的距离和分布。所以在随机的负载下，就很少表现出局部性。但是，因为最终每个文件都共享一个共同的祖先(例如根)，所以存在一些局部性，因此 random 作为比较点很有用<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723112512.png" alt="20200723112512" loading="lazy"></li>
</ul>
<h3 id="the-large-file-exception">The Large-File Exception</h3>
<ul>
<li>大文件可能直接一次就填满整个数据块组，以这种方式填充块组是不可取的，因为这会防止随后的“相关”文件被放置在这个块组中，从而可能会损害文件访问位置。所以有必要设置单独的策略。</li>
<li>大文件的分配策略就是 在第一个组中分配了一定数量的数据块之后，找到其他组继续分配该文件对应的数据块，可能会根据每个组的空间利用情况进行选择。</li>
<li>假设一个组 10 inodes, 40 data blocks，文件 <code>/a</code> 大小为 30 个块<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723114144.png" alt="20200723114144" loading="lazy"><br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723114153.png" alt="20200723114153" loading="lazy"></li>
<li>但是这样散布之后可能会影响该大文件的访问性能，所以选择分片大小就显得十分重要，如果足够大，那就是大部分时间都在传输，少部分时间在 seek，是一种 amortization 策略。</li>
<li>假设定位时间为 10ms，磁盘传输速度为 40MB/S，如果目标是一半时间用于定位，一半时间用于传输，即发挥 50% 的磁盘峰值带宽，那么每 10ms 定位之后就进行 10ms 的传输，对应的可以传输大约 409.6KB 的数据。对应如果发挥 90% 的峰值带宽，大约为 3.69MB，99% 峰值带宽大约为 40.6 MB，对应的离峰值越近，数据块大小也就越大。<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723145119.png" alt="20200723145119" loading="lazy"></li>
<li>FFS 没有用这种方式来计算大文件在不同组之间的分布，而是采用了一个比较简单的方法，基于本身的 inode 的结构。每一个间接块，以及它所指向的所有块，都被放在不同的组中。4KB 大小的块，32 位地址，在该策略下就意味着 4MB 文件的 1024 个块会被放置到不同的组，唯一的例外是由直接指针指向的文件的第一个 48KB。</li>
<li>从图示结果中不难发现磁盘传输率提升的越来越快，因为磁盘制造商擅长将更多的位元塞入同一表面，但与seek相关的驱动器的机械方面(磁盘臂速度和旋转速度)改进得相当缓慢。这意味着，随着时间的推移，机械成本会变得相对更昂贵，因此，为了摊销上述成本，您必须在各个 seek 之间转移更多的数据。</li>
</ul>
<h3 id="a-few-other-things-about-ffs">A Few Other Things About FFS</h3>
<h4 id="sub-blocks">sub-blocks</h4>
<ul>
<li>小文件会带来一些磁盘内部的碎片现象，比如 2KB 的文件，使用 4KB 的块则其实是浪费了一半的空间。FFS 的设计者想到了一个简单的办法来解决，引入 <strong>sub-blocks</strong>，即文件系统可以分配给文件的一些较小的数据块。因此如果创建小文件，譬如 1KB 文件，将直接使用两个 sub-blocks 而不用浪费一个 4KB 的块大小。随着文件大小的增长，文件系统将持续分配 512 字节的块直到 4KB 的大小，在这时候，文件系统将分配一个 4KB 大小的块，并把小块数据复制到该大块中，然后释放掉小块的空间。</li>
<li>这个过程可能不够高效，因为引入了额外的工作，譬如为了复制的一些 I/O，FFS 为了避免这种行为，修改了 libc 库，该库将缓冲写操作，然后将写操作直接写到 4KB 大小的块中，因此在大多数场景中完全避免了对小块的特殊处理。</li>
</ul>
<h4 id="disk-layout">disk layout</h4>
<ul>
<li>在 SCSI 以及其他现代设备接口之前，磁盘是比较简易的并且要求主机 CPU 亲历亲为地控制磁盘的操作。在 FFS 中，如果将文件放在磁盘的连续扇区上，就会出现问题。如下图左图所示，在顺序读的过程中，首先读数据块 0，完成之后读取数据块 1，但是读数据快 1 的时候可能发现磁盘已经转动过了，即需要再等待额外的完整的旋转时延才能读取数据块 1.</li>
<li>FFS 采用了如下右图所示方法，通过在连续的数据块之间间隔一个其他的块的方式，在经过磁盘头之前，FFS 有足够的时间请求下一个块。事实上，FFS 能够计算出具体的需要多少个块来间隔，这个技术被称之为 <strong>parameterization</strong>，因为 FFS 会计算出磁盘的具体性能参数，并使用这些参数来决定精确的交错布局方案。<br>
<img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200723152257.png" alt="20200723152257" loading="lazy"></li>
<li>这种方法可能也有问题，即性能上可能只能达到峰值的一半，因为扫描一个磁道上的所有数据的话必须旋转两次才可以全部访问到。但现代文件系统内部读取整个磁道，并将其缓冲在一个内部磁盘缓存中(由于这个原因通常称为磁道缓冲区)。<strong>即预取</strong>。而针对顺序读操作，则直接从对应的 track buffer 中缓存相应的数据。文件系统因此不再需要担心这些难以置信的底层细节。如果设计得当，抽象和高级接口可能是一件好事。</li>
</ul>
<h4 id="other">other</h4>
<ul>
<li>FFS 是首批支持较长的文件名的文件系统之一，从而在文件系统中启用更具表达性的名称，而不是传统的固定大小的方法</li>
<li>FFS 引入了软链接</li>
<li>FFS 也引入了 rename 原子操作</li>
<li>引入了 advisory shared/exclusive locks 以方便地构建并发程序；</li>
<li>引入了 Quotas 机制，让管理员能更合理地对每个用户实施配额限制，包括具体到inode 和 data block 数目的限制。</li>
</ul>

                        </div>
                        
                            <div class="post-toc">
                                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#chapter-index">Chapter Index</a></li>
<li><a href="#locality-and-the-fast-file-system">Locality and The Fast File System</a>
<ul>
<li><a href="#ffs-disk-awareness-is-the-solution">FFS: Disk Awareness Is The Solution</a></li>
<li><a href="#organizing-structure-the-cylinder-group">Organizing Structure: The Cylinder Group</a></li>
<li><a href="#policies-how-to-allocate-files-and-directories">Policies: How To Allocate Files and Directories</a></li>
<li><a href="#measuring-file-locality">Measuring File Locality</a></li>
<li><a href="#the-large-file-exception">The Large-File Exception</a></li>
<li><a href="#a-few-other-things-about-ffs">A Few Other Things About FFS</a>
<ul>
<li><a href="#sub-blocks">sub-blocks</a></li>
<li><a href="#disk-layout">disk layout</a></li>
<li><a href="#other">other</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

                            </div>
                            
                                
                                    
                                            <!--zh-->
                                            <section class="post-copyright zh">
                                                <p class="copyright-item ">
                                                    <span>&#x4F5C;&#x8005;:</span>
                                                    <span>Elvis Zhang</span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x6C38;&#x4E45;&#x94FE;&#x63A5;:</span>
                                                    <span><a href="https://blog.shunzi.tech/post/basic-of-persistence-five/">https://blog.shunzi.tech/post/basic-of-persistence-five/</a></span>
                                                </p>

                                                <p class="copyright-item">
                                                    <span>&#x534F;&#x8BAE;:</span>
                                                    <span>MIT License</span>
                                                </p>
                                            </section>
                                            
                                                
                                                    
                                                                    <!--Share-->
                                                                    <span style="margin-right:15px">
                        <i class="post-share"></i>
                        <span>&#x5206;&#x4EAB;:</span>
                                                                    <a title="QR 码" target="_blank" href="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://blog.shunzi.tech/post/basic-of-persistence-five/"><i class="fa fa-qrcode"></i></a>
                                                                    <a title="QQ" target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://blog.shunzi.tech/post/basic-of-persistence-five/&sharesource=qzone&title=Series Five of Basic of Persistence -  Locality and The Fast File System&pics=https://blog.shunzi.tech/images/avatar.png?v=1624327255085&summary=&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;本篇为持久化技术的基础篇系列第五篇（局部性和 Fast File System），将以 FFS 为例，可以参考原版论文 &lt;a href=&#34;https://dl.acm.org/doi/10.1145/989.990&#34;&gt;A fast file system for UNIX&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
"><i class="fa fa-qq"></i></a>
                                                                    <a title="新浪微博" target="_blank" href="https://service.weibo.com/share/share.php?url=https://blog.shunzi.tech/post/basic-of-persistence-five/&sharesource=weibo&title=Series Five of Basic of Persistence -  Locality and The Fast File System + " - " + &lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;本篇为持久化技术的基础篇系列第五篇（局部性和 Fast File System），将以 FFS 为例，可以参考原版论文 &lt;a href=&#34;https://dl.acm.org/doi/10.1145/989.990&#34;&gt;A fast file system for UNIX&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&pic="https://blog.shunzi.tech/images/avatar.png?v=1624327255085 "><i class="fa fa-weibo "></i></a>

                                                                    </span>
                                                                    
                                                                            <!--zh-->
                                                                            <section class="post-tags zh ">
                                                                                <div>
                                                                                    <span>&#x6807;&#x7B7E;:</span>
                                                                                    <span class="tag ">
                        
                        
                        <a href="https://blog.shunzi.tech/tag/3zCwFWPHxH/">#
                    存储
                        </a>
                        
                        <a href="https://blog.shunzi.tech/tag/la-n8a0mo/">#
                    读书笔记
                        </a>
                        
                        <a href="https://blog.shunzi.tech/tag/os/">#
                    OS
                        </a>
                        
                            
                                </span>
                                                                                </div>
                                                                                <div>
                                                                                    <a href="javascript:window.history.back();">
                        &#x8FD4;&#x56DE;</a>
                                                                                    <span>&dot;</span>
                                                                                    <a href="#">&#x4E3B;&#x9875;</a>
                                                                                </div>
                                                                            </section>

                                                                            
                                                                                <!---->
                                                                                <section class="post-nav">
                                                                                    
                                                                                        <a class="prev" rel="prev" href="https://blog.shunzi.tech/post/basic-of-persistence-six/">
                                                                                            Series Six of Basic of Persistence -  Log-structured File System
                                                                                        </a>
                                                                                        
                                                                                            
                                                                                                <a class="next" rel="next" href="https://blog.shunzi.tech/post/basic-of-persistence-four/">
                                                                                                    Series Four of Basic of Persistence -  File System Implementation
                                                                                                </a>
                                                                                                
                                                                                </section>
                    </article>
                </div>
                <div class="post-wrap">
                
                                            
                                                <script type="application/javascript" src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
<div id="vlaine-comment"></div>
<script type="application/javascript">
    new Valine({
        el: '#vlaine-comment',
        appId: 'Pj5H1z0w7hJlLGJpGBh9NrCq-MdYXbMMI',
        appKey: 'LdR8vK5EaBfK87esF7tlbsXe',
        pageSize: 5,
        avatar: 'mp',
        placeholder: '来都来了，不妨评论一下',
        visitor: false,
        highlight: false,
        recordIP: false,
    })
</script>
                                                    
                                                </div>
            </div>
    </div>
    </div>
    </div>
    
    <div id="player"></div>
    
        <footer id="footer" class="footer">
            <div class="copyright">
                
                        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
                            
                                <b id="hitokoto"></b><br>
                                
                                        <svg viewBox="0 0 1024 1024" style="margin-left: 5px;margin-right: 5px;" version="1.0" width="8" height="8" class="my-face">
            <path
                d="M863.597631 513.574282l-271.33965-140.213484L729.783667 81.926656c3.583731-7.87141 7.167462-15.742819 7.167462-25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0-39.293053 12.607055c-1.791866 1.59988-3.519736 3.19976-5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0-19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c-12.479064 25.214109-1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591-4.735645 44.604655-15.742819l480.091993-403.297753a55.547834 55.547834 0 0 0 19.646526-47.228458 61.243407 61.243407 0 0 0-32.12559-44.156688z"
                fill="#93b5cf"></path>
        </svg>
                                        Elvis Zhang &copy;Copyright
                                            <script>
                                                var date = new Date();
                                                document.write("" + date.getFullYear());
                                            </script>
                                            | Powered by
                                            <a href="https://github.com/" target="_blank">
                                                Github Pages
                                            </a>
            </div>
            <div id="update" style="display:none;">
                on
            </div>
            
                <div id="version" style="display:none;">
                    1.7.6
                </div>
                
                    <script>
                        var port = '';
                        
                        document.write('<div id="home_path" style="display:none;">' + document.location.protocol + '//' + window.document.location.hostname + port + '</div>')
                    </script>
        </footer>
        
            <script src='https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js'></script>
            
                <script>
                    

                    function LoadPlayer() {
                        var musicList = [];
                        
                        musicList.push({
                            name: 'See You Again (feat. Charlie Puth)',
                            url: 'https://link.jscdn.cn/1drv/aHR0cHM6Ly8xZHJ2Lm1zL3UvcyFBbmlqSWg1RWM0TlZoSXhtUU9nLTk3R2g5cDVlblE.mp3',
                            artist: 'Charlie Puth',
                            cover: 'https://4.bp.blogspot.com/-tk-Dzg0cHNQ/WnxPiEImF8I/AAAAAAAAMbg/FisRjWssG3kMFGiMh1BE3j4U6QnI2O3rwCLcBGAs/s1600/wiz-khalifa-see-you-again.jpg',
                        });
                        
                        console.log(" MusicList: " + musicList);
                        
                        const ap = new APlayer({
                            container: document.getElementById('player'),
                            fixed: true,
                            audio: musicList
                        });
                        
                    }
                    LoadPlayer();
                    
                    
                    loadlive2d();
                    
                    
                    hitokoto();
                    
                    getStar();
                    hljs.initHighlighting();
                    console.clear();
                    
                    CheckVersion();
                    
                    var newDate = new Date();
                    newDate.setTime(1624327255085);
                    console.log(" Blog Update Time: " + newDate.toLocaleDateString());
                    console.log("\n %c \u26a1Theme:Chic Author's Blog:https://blog.itjoker.cn  Write By ITJoker  \n\n", "color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;");
                </script>
        </div>
</body>
<script>
    scroll();
</script>

</html>